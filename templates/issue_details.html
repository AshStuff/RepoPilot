{% extends "base.html" %}

{% block title %}{{ issue.title }} - Issue #{{ issue.number }}{% endblock %}

{% block head %}
<!-- Repository and issue metadata -->
<meta name="repository-name" content="{{ repository.full_name }}">
<meta name="issue-number" content="{{ issue.number }}">
{% endblock %}

{% block styles %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .dashboard-container {
        display: flex;
        height: 100vh;
    }

    /* Sidebar styles */
    .sidebar {
        width: 250px;
        min-width: 250px;
        background-color: #2f3136;
        border-right: 1px solid #26282c;
        height: 100vh;
        color: #dcddde;
        display: flex;
        flex-direction: column;
    }

    /* User profile section */
    .user-profile {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid #26282c;
        background-color: #2f3136;
    }

    .avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 10px;
        border: 2px solid #dcddde;
    }

    .user-profile h3 {
        margin: 10px 0 5px;
        color: #ffffff;
    }

    .user-profile p {
        color: #dcddde;
        font-size: 0.9em;
    }

    /* Navigation links */
    .sidebar-nav {
        display: flex;
        flex-direction: column;
        padding: 10px 0;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #dcddde;
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }

    .nav-link i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }

    .nav-link.active {
        background-color: #393c43;
        color: #ffffff;
        border-left-color: #7289da;
    }

    .nav-link:hover:not(.active) {
        background-color: #36393f;
        border-left-color: #dcddde;
    }

    .nav-link.logout {
        margin-top: auto;
        color: #ed4245;
        border-top: 1px solid #26282c;
    }

    .nav-link.logout:hover {
        background-color: #ed4245;
        color: white;
    }

    /* Main content */
    .main-content {
        flex: 1;
        background-color: #fff;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .content-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f6f8fa;
    }

    .issue-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .issue-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        background-color: #fff;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .issue-title {
        font-size: 1.5rem;
        color: #24292e;
    }

    .issue-title a {
        color: #586069;
        text-decoration: none;
    }

    .issue-title a:hover {
        color: #0366d6;
        text-decoration: underline;
    }

    /* Tab styles */
    .issue-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e1e4e8;
        padding: 0 1rem;
        background-color: #fff;
        border-radius: 6px 6px 0 0;
    }

    .tab-button {
        padding: 1rem;
        border: none;
        background: none;
        color: #586069;
        font-size: 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
    }

    .tab-button:hover {
        color: #24292e;
    }

    .tab-button.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
        font-weight: 500;
    }

    .tab-content {
        display: none;
        background-color: #fff;
        border-radius: 0 0 6px 6px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .tab-content.active {
        display: block;
    }

    /* Issue details styles */
    .issue-details {
        margin-bottom: 2rem;
    }

    .issue-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #586069;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .issue-labels {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .issue-label {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .issue-body {
        color: #24292e;
        line-height: 1.5;
    }

    /* Comments section */
    .comments-section {
        margin-top: 2rem;
    }

    .comment {
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        margin-bottom: 1rem;
        padding: 1rem;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .comment-author {
        font-weight: 500;
        color: #24292e;
    }

    .comment-time {
        color: #586069;
        font-size: 0.9rem;
    }

    .comment-body {
        color: #24292e;
        line-height: 1.5;
    }

    /* Footer styles */
    .footer {
        background-color: #ffffff;
        color: #666666;
        padding: 15px 20px;
        text-align: center;
        font-size: 0.9em;
        border-top: 1px solid #e0e0e0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
    }

    .footer-links {
        display: flex;
        gap: 20px;
    }

    .footer a {
        color: #666666;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .footer a:hover {
        color: #333333;
    }

    /* Add these new styles */
    .issue-main-title {
        background-color: #fff;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .issue-main-title h2 {
        font-size: 1.8rem;
        color: #24292e;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .issue-meta-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .issue-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 1rem;
        border-radius: 2rem;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .issue-status.open {
        background-color: #2ea44f20;
        color: #2ea44f;
    }

    .issue-status.closed {
        background-color: #d73a4920;
        color: #d73a49;
    }

    .issue-status i {
        font-size: 1rem;
    }

    /* Update existing styles */
    .issue-details h2 {
        display: none; /* Hide the duplicate title in the details section */
    }

    /* Add these markdown content styles */
    .markdown-content {
        color: #24292e;
        line-height: 1.5;
        font-size: 1rem;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        margin: 1.5rem 0 1rem;
        font-weight: 600;
        line-height: 1.25;
    }

    .markdown-content h1 { font-size: 2em; }
    .markdown-content h2 { font-size: 1.5em; }
    .markdown-content h3 { font-size: 1.25em; }
    .markdown-content h4 { font-size: 1em; }
    .markdown-content h5 { font-size: 0.875em; }
    .markdown-content h6 { font-size: 0.85em; }

    .markdown-content p {
        margin-bottom: 1rem;
    }

    .markdown-content ul,
    .markdown-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }

    .markdown-content li {
        margin: 0.25rem 0;
    }

    .markdown-content code {
        padding: 0.2em 0.4em;
        margin: 0;
        font-size: 85%;
        background-color: #f6f8fa;
        border-radius: 6px;
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    }

    .markdown-content pre {
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f6f8fa;
        border-radius: 6px;
        overflow-x: auto;
    }

    .markdown-content pre code {
        padding: 0;
        background-color: transparent;
        font-size: 0.9em;
        line-height: 1.45;
    }

    .markdown-content blockquote {
        padding: 0 1em;
        color: #6a737d;
        border-left: 0.25em solid #dfe2e5;
        margin-bottom: 1rem;
    }

    .markdown-content img {
        max-width: 100%;
        height: auto;
        margin: 1rem 0;
    }

    .markdown-content table {
        border-spacing: 0;
        border-collapse: collapse;
        margin-bottom: 1rem;
        width: 100%;
    }

    .markdown-content table th,
    .markdown-content table td {
        padding: 6px 13px;
        border: 1px solid #dfe2e5;
    }

    .markdown-content table tr {
        background-color: #fff;
        border-top: 1px solid #c6cbd1;
    }

    .markdown-content table tr:nth-child(2n) {
        background-color: #f6f8fa;
    }

    /* Syntax highlighting */
    .highlight {
        background-color: #f6f8fa;
        border-radius: 6px;
    }

    .highlight pre {
        margin-bottom: 0;
        padding: 1rem;
    }

    /* Add terminal styles */
    .terminal-container {
        background-color: #1e1e1e;
        border-radius: 6px;
        padding: 1rem;
        height: 500px; /* Adjusted height */
        display: flex;
        flex-direction: column;
    }

    .terminal-header {
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        border-bottom: 1px solid #333;
        margin-bottom: 1rem;
    }

    .terminal-title {
        color: #fff;
        font-size: 0.9rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .terminal-controls { /* For window dressing buttons */
        display: flex;
        gap: 0.5rem;
    }

    .terminal-button {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
    }

    .terminal-button.close { background-color: #ff5f56; }
    .terminal-button.minimize { background-color: #ffbd2e; }
    .terminal-button.maximize { background-color: #27c93f; }

    /* Remove terminal input styles */
    .terminal-input-container,
    .terminal-prompt,
    .terminal-input {
        display: none;
    }

    /* Update terminal content to fill the space */
    .terminal-content {
        flex: 1;
        overflow-y: auto;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        color: #fff;
        padding-right: 1rem;
        padding-bottom: 1rem; /* Add padding at bottom for better spacing */
    }

    .log-entry {
        margin-bottom: 0.5rem;
        display: flex;
        align-items: flex-start;
    }

    .log-timestamp {
        color: #888;
        margin-right: 1rem;
        flex-shrink: 0;
        min-width: 140px; /* Fixed width for timestamps to align content */
    }

    .log-message {
        flex: 1;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .log-message.info { color: #7cafc2; }
    .log-message.success { color: #a1b56c; }
    .log-message.error { color: #ab4642; }
    .log-message.warning { color: #f7ca88; }
    
    /* Special styling for separator lines and section headers in terminal */
    .log-message.separator {
        color: #d7875f;
        font-weight: bold;
    }
    
    .log-message.section-header {
        color: #ffcc00;
        font-weight: bold;
        text-align: center;
    }

    /* Styles for markdown-formatted logs */
    .log-message.markdown-formatted {
        padding: 0.5rem;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        margin-top: 0.5rem;
    }
    
    .log-message.markdown-formatted code {
        background-color: rgba(0, 0, 0, 0.3);
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    }
    
    .log-message.markdown-formatted pre {
        background-color: rgba(0, 0, 0, 0.3);
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.5rem 0;
        overflow-x: auto;
    }
    
    .log-message.markdown-formatted h1,
    .log-message.markdown-formatted h2,
    .log-message.markdown-formatted h3,
    .log-message.markdown-formatted h4 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        color: #ddd;
    }
    
    .log-message.markdown-formatted ul,
    .log-message.markdown-formatted ol {
        padding-left: 1.5rem;
        margin: 0.5rem 0;
    }
    
    .log-message.markdown-formatted table {
        border-collapse: collapse;
        margin: 0.5rem 0;
    }
    
    .log-message.markdown-formatted th,
    .log-message.markdown-formatted td {
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 4px 8px;
    }
    
    .log-message.markdown-formatted a {
        color: #7cafc2;
        text-decoration: underline;
    }

    /* Add styling for the missing info alert */
    .missing-info-alert {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 6px;
        padding: 20px;
        margin: 20px 0;
        color: #856404;
    }
    
    .missing-info-alert h3 {
        color: #856404;
        margin-bottom: 15px;
    }
    
    .retry-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
    }
    
    .retry-button:hover {
        background-color: #0069d9;
    }

    /* Styles for environment analysis */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .info-group {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .info-group h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #24292e;
        border-bottom: 1px solid #e1e4e8;
        padding-bottom: 8px;
    }

    .info-group ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .info-group li {
        margin: 8px 0;
        color: #586069;
    }
    
    .spinner {
        display: inline-block;
        animation: spin 1s linear infinite;
        color: #1a73e8;
        font-weight: bold;
    }
    
    .hidden {
        display: none;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    #ai-insights {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #e1e4e8;
    }

    /* Add status indicator styles */
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 10px;
        font-size: 22px; /* Increase size of indicators further */
    }

    .success-indicator {
        color: #28a745;
        font-weight: bold;
    }

    .error-indicator {
        color: #dc3545;
        font-weight: bold;
    }

    /* Git diff visualization styles */
    .git-changes-section {
        background-color: #f8f9fa;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        padding: 20px;
        margin: 20px 0;
    }

    .git-diff-button {
        background-color: #0366d6;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 14px;
        margin: 15px 0;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .git-diff-button:hover {
        background-color: #0256cc;
    }

    .git-diff-container {
        background-color: #fff;
        border: 1px solid #d1d5da;
        border-radius: 6px;
        margin-top: 15px;
        max-height: 600px;
        overflow-y: auto;
    }

    .file-diff {
        border-bottom: 1px solid #e1e4e8;
    }

    .file-diff:last-child {
        border-bottom: none;
    }

    .file-diff-header {
        background-color: #fafbfc;
        padding: 10px 15px;
        border-bottom: 1px solid #e1e4e8;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .file-status {
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: 500;
    }

    .file-status.new_file {
        background-color: #d4edda;
        color: #155724;
    }

    .file-status.modified {
        background-color: #fff3cd;
        color: #856404;
    }

    .file-status.error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .diff-content {
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
        font-size: 12px;
        line-height: 1.45;
        color: #24292e;
        background-color: transparent;
        border: 0;
        padding: 0;
        margin: 0;
        white-space: pre;
        word-wrap: normal;
        tab-size: 8;
    }

    .diff-content code {
        background-color: transparent;
        border: 0;
        display: inline;
        line-height: inherit;
        margin: 0;
        max-width: auto;
        overflow: visible;
        padding: 10px;
        word-wrap: normal;
        display: block;
    }

    .no-changes-section,
    .git-error-section {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        color: #856404;
    }

    .git-error-section {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="user-profile">
            <img src="{{ user.avatar_url }}" alt="Profile" class="avatar">
            <h3>{{ user.name or user.login }}</h3>
            <p>@{{ user.login }}</p>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
                <i class="fas fa-book"></i>
                Repositories
            </a>
            <a href="{{ url_for('review_pr') }}" class="nav-link">
                <i class="fas fa-tasks"></i>
                Review PR
            </a>
            <a href="{{ url_for('settings') }}" class="nav-link">
                <i class="fas fa-cog"></i>
                Settings
            </a>
            <a href="#" class="nav-link logout" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </nav>
        <form id="logout-form" action="{{ url_for('logout') }}" method="POST" style="display: none;"></form>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-wrapper">
            <div class="issue-container">
                <div class="issue-header">
                    <h1 class="issue-title">
                        <a href="{{ url_for('repository_issues', repo_name=repository.full_name) }}">{{ repository.name }}</a>
                        / Issue #{{ issue.number }}
                    </h1>
                </div>

                <!-- Issue Title -->
                <div class="issue-main-title">
                    <h2>{{ issue.title }}</h2>
                    <div class="issue-meta-header">
                        <span class="issue-status {% if issue.state == 'open' %}open{% else %}closed{% endif %}">
                            <i class="fas {% if issue.state == 'open' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
                            {{ issue.state|capitalize }}
                        </span>
                        {% if issue.labels %}
                        <div class="issue-labels">
                            {% for label in issue.labels %}
                            <span class="issue-label">
                                {{ label.name }}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Issue Tabs -->
                <div class="issue-tabs">
                    <button class="tab-button active" data-tab="issue" onclick="try { directTabSwitch('issue'); } catch(e) { document.getElementById('issue').style.display='block'; }; return false;">
                        <i class="fas fa-exclamation-circle"></i> Issue
                    </button>
                    <button class="tab-button" data-tab="workspace" onclick="try { directTabSwitch('workspace'); } catch(e) { document.getElementById('workspace').style.display='block'; }; return false;">
                        <i class="fas fa-code"></i> Workspace
                    </button>
                    <button class="tab-button" data-tab="summary" onclick="try { directTabSwitch('summary'); } catch(e) { document.getElementById('summary').style.display='block'; }; return false;">
                        <i class="fas fa-chart-bar"></i> Summary
                    </button>
                </div>

                <!-- Issue Tab Content -->
                <div id="issue" class="tab-content active" style="display: block;">
                    <div class="issue-details">
                        <div class="issue-meta">
                            <span>
                                <i class="fas fa-user"></i>
                                {{ issue.user.login }}
                            </span>
                            <span>
                                <i class="fas fa-clock"></i>
                                {{ issue.created_at|datetime }}
                            </span>
                        </div>
                        <div class="issue-body markdown-content">
                            {{ issue.body|markdown|safe }}
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="comments-section">
                            <h3>Comments ({{ comments|length }})</h3>
                            {% for comment in comments %}
                            <div class="comment">
                                <div class="comment-header">
                                    <span class="comment-author">{{ comment.user.login }}</span>
                                    <span class="comment-time">commented {{ comment.created_at|datetime }}</span>
                                </div>
                                <div class="comment-body markdown-content">
                                    {{ comment.body|markdown|safe }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Workspace Tab Content -->
                <div id="workspace" class="tab-content" style="display: none;">
                    <div class="terminal-container" style="height: 600px;">
                        <div class="terminal-header">
                            <div class="terminal-controls">
                                <button class="terminal-button close"></button>
                                <button class="terminal-button minimize"></button>
                                <button class="terminal-button maximize"></button>
                            </div>
                            <div class="terminal-title">
                                Issue Analysis Terminal
                                <span id="analysis-status-indicator" class="status-indicator">
                                    <span id="loading-spinner" class="spinner">⟳</span>
                                    <span id="success-indicator" class="success-indicator hidden">✓</span>
                                    <span id="error-indicator" class="error-indicator hidden">✗</span>
                                </span>
                            </div>
                        </div>
                        <div class="terminal-content" id="terminalContent">
                            {% if logs %}
                                {% for log in logs %}
                                    <div class="log-entry">
                                        <span class="log-timestamp">
                                            {% if log.timestamp %}
                                                {{ log.timestamp|datetime }}
                                            {% else %}
                                                {{ issue.created_at|datetime }}
                                            {% endif %}
                                        </span>
                                        <span class="log-message {{ log.type }}">{{ log.message }}</span>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="log-entry">
                                    <span class="log-timestamp">{{ issue.created_at|datetime }}</span>
                                    <span class="log-message info">Initializing issue analysis...</span>
                                </div>
                                <div class="log-entry">
                                    <span class="log-timestamp">{{ issue.created_at|datetime }}</span>
                                    <span class="log-message info">No logs available yet. Analysis may be pending.</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Hide the container section - we'll show all info in the terminal logs -->
                    <div id="analysis-container" style="display: none;">
                        <div id="container-section" style="display: none;">
                            <h3>Environment Details</h3>
                            <div class="info-grid">
                                <div class="info-group">
                                    <h4>Container</h4>
                                    <ul>
                                        <li><strong>ID:</strong> <span id="container-id">-</span></li>
                                        <li><strong>Status:</strong> <span id="container-status">-</span></li>
                                        <li><strong>Name:</strong> <span id="container-name">-</span></li>
                                    </ul>
                                </div>
                                <div class="info-group">
                                    <h4>System</h4>
                                    <ul>
                                        <li><strong>OS:</strong> <span id="env-os">-</span></li>
                                        <li><strong>Python:</strong> <span id="env-python">-</span></li>
                                    </ul>
                                </div>
                                <div class="info-group">
                                    <h4>Packages</h4>
                                    <ul id="env-packages">
                                        <li>No packages detected</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <h3>AI Insights</h3>
                            <div id="ai-insights" class="markdown-content">
                                <p>Analysis in progress...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Also hide loading indicator -->
                    <div id="loading-analysis" style="display: none;"></div>
                </div>

                <!-- Summary Tab Content -->
                <div id="summary" class="tab-content" style="display: none;">
                    <h2>Summary</h2>
                    
                    {% if analysis and analysis.final_output %}
                        <!-- Processing Time Section -->
                        {% if analysis and analysis.aider_processing_time_seconds is not none %}
                            <div class="processing-time-section" style="margin-top: 20px; padding: 10px; background-color: #e8f0fe; border-radius: 4px;">
                                <p style="margin: 0; color: #1967d2;">
                                    <i class="fas fa-stopwatch"></i> Time from Issue to PR ready: 
                                    <strong>
                                        {% if analysis.processing_time_minutes > 0 %}
                                            {{ analysis.processing_time_minutes }} minute{{ 's' if analysis.processing_time_minutes != 1 else '' }} 
                                        {% endif %}
                                        {{ analysis.processing_time_seconds_remainder }} seconds
                                    </strong>
                                </p>
                            </div>
                        {% endif %}
                        
                        <!-- Git Changes Section -->
                        {% if analysis and analysis.git_changes and analysis.git_changes.has_changes %}
                            <div class="git-changes-section" style="margin-top: 20px;">
                                <h3>Code Changes</h3>
                                <p>{{ (analysis.git_changes.summary | default('', True)).replace("Pull Request created: View PR", "").strip() | markdown | safe }}</p>
                                
                                <div class="git-changes-files" style="margin: 15px 0;">
                                    <strong>Modified Files ({{ analysis.git_changes.changed_files|length }}):</strong>
                                    <ul style="margin: 10px 0; padding-left: 20px;">
                                        {% for file_path in analysis.git_changes.changed_files %}
                                            <li style="margin: 5px 0; font-family: monospace;">{{ file_path }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="action-buttons-container" style="display: flex; gap: 10px; align-items: center; margin-top: 15px; margin-bottom: 15px;">
                                    <button id="toggle-git-diff" class="git-diff-button" onclick="toggleGitDiff()" style="margin: 0;">
                                        📋 View Git Diff
                                    </button>
                                    {% if analysis and analysis.pr_url %}
                                        <a href="{{ analysis.pr_url }}" target="_blank" class="git-diff-button" style="text-decoration: none; display: inline-flex; align-items: center; margin: 0;">
                                            <i class="fab fa-github" style="margin-right: 8px;"></i> View Pull Request
                                        </a>
                                    {% endif %}
                                </div>
                                
                                <div id="git-diff-container" class="git-diff-container" style="display: none;">
                                    <div class="git-diff-content">
                                        {% for file_path, file_info in analysis.git_changes.file_diffs.items() %}
                                            <div class="file-diff" style="margin-bottom: 20px;">
                                                <div class="file-diff-header">
                                                    <strong>{{ file_path }}</strong>
                                                    <span class="file-status {{ file_info.status }}">
                                                        {% if file_info.status == 'new_file' %}(new file)
                                                        {% elif file_info.status == 'modified' %}(modified)
                                                        {% elif file_info.status == 'error' %}(error)
                                                        {% endif %}
                                                    </span>
                                                </div>
                                                <pre class="diff-content"><code>{{ file_info.diff }}</code></pre>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% elif analysis and analysis.git_changes and not analysis.git_changes.has_changes %}
                            <div class="no-changes-section" style="margin-top: 20px;">
                                <h3>Code Changes</h3>
                                <p>No file changes were detected after the analysis.</p>
                            </div>
                        {% elif analysis and analysis.git_changes and analysis.git_changes.error %}
                            <div class="git-error-section" style="margin-top: 20px;">
                                <h3>Code Changes</h3>
                                <p><strong>Error:</strong> {{ analysis.git_changes.error }}</p>
                            </div>
                        {% endif %}

                        <!-- Explanation Section -->
                        <div class="markdown-content" id="summary-explanation" style="margin-top: 30px;">
                            {{ (analysis.final_output | default('', True)).replace("Pull Request created: View PR", "").strip() | markdown | safe }}
                        </div>

                    {% elif analysis and analysis.analysis_status == 'in_progress' %}
                        <p>Analysis is currently in progress. The summary will be available once it's complete.</p>
                    {% elif analysis and analysis.analysis_status == 'pending' %}
                        <p>Analysis is pending. The summary will be available once it starts and completes.</p>
                    {% elif analysis and analysis.analysis_status == 'failed' %}
                        <p>Analysis failed. No summary could be generated. Please check the workspace logs for more details.</p>
                        {% if analysis.error_message %}
                            <p><strong>Error:</strong> {{ analysis.error_message }}</p>
                        {% endif %}
                    {% else %}
                        <p>No summary available yet. The analysis may not have run or completed.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-copyright">
                    © 2024 RepoPilot. All rights reserved.
                </div>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Contact</a>
                </div>
            </div>
        </footer>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include utility scripts -->
<script src="{{ url_for('static', filename='js/tab-switcher.js') }}"></script>
<script src="{{ url_for('static', filename='js/direct-tab-fix.js') }}"></script>

<!-- Temporarily disable conflicting log polling scripts to prevent conflicts with SSE -->
<!-- 
<script src="{{ url_for('static', filename='js/force-logs.js') }}"></script>
<script src="{{ url_for('static', filename='js/auto-logs.js') }}"></script>
<script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script src="{{ url_for('static', filename='js/terminal-fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/direct-analyzer-logs.js') }}"></script>
<script src="{{ url_for('static', filename='js/terminal-functions.js') }}"></script>
<script src="{{ url_for('static', filename='js/onetime-fix.js') }}"></script>
<script src="{{ url_for('static', filename='js/log-debugger.js') }}"></script>
-->

<!-- Add marked.js for client-side markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Configure marked options
marked.setOptions({
    highlight: function(code, lang) {
        return code;
    },
    breaks: true,
    gfm: true
});

// Git diff toggle function
function toggleGitDiff() {
    const container = document.getElementById('git-diff-container');
    const button = document.getElementById('toggle-git-diff');
    
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        button.innerHTML = '📋 Hide Git Diff';
    } else {
        container.style.display = 'none';
        button.innerHTML = '📋 View Git Diff';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up auto-refresh...');

    // Simple auto-refresh fallback - reload page every 10 seconds
    let autoRefreshInterval;
    let refreshEnabled = true;
    
    function startAutoRefresh() {
        if (refreshEnabled) {
            console.log('🔄 Starting auto-refresh every 10 seconds');
            autoRefreshInterval = setInterval(function() {
                console.log('🔄 Auto-refreshing page...');
                // Only refresh if we're still on the workspace tab or if there's activity
                const workspaceTab = document.getElementById('workspace');
                if (workspaceTab && workspaceTab.style.display !== 'none') {
                    window.location.reload();
                }
            }, 10000); // Refresh every 10 seconds
        }
    }
    
    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            console.log('⏹️ Stopping auto-refresh');
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }

    // Add a visual indicator for auto-refresh
    const terminalContent = document.getElementById('terminalContent');
    if (terminalContent) {
        const refreshIndicator = document.createElement('div');
        refreshIndicator.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 1000;
        `;
        refreshIndicator.innerHTML = '🔄 Auto-refresh: ON (10s)';
        refreshIndicator.id = 'refresh-indicator';
        
        // Make terminal container position relative
        const terminalContainer = terminalContent.closest('.terminal-container');
        if (terminalContainer) {
            terminalContainer.style.position = 'relative';
            terminalContainer.appendChild(refreshIndicator);
        }
    }

    // Stop refresh when user switches away from workspace tab
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            if (tabName === 'workspace') {
                console.log('🔄 Workspace tab activated - starting auto-refresh');
                startAutoRefresh();
                const indicator = document.getElementById('refresh-indicator');
                if (indicator) indicator.style.display = 'block';
            } else {
                console.log('⏹️ Other tab activated - stopping auto-refresh');
                stopAutoRefresh();
                const indicator = document.getElementById('refresh-indicator');
                if (indicator) indicator.style.display = 'none';
            }
        });
    });

    // Check which tab is initially active
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab && activeTab.id === 'workspace') {
        console.log('🔄 Starting on workspace tab - enabling auto-refresh');
        startAutoRefresh();
    }

    // Stop refresh when user navigates away
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });

    // Pause refresh when page is not visible (user switched tabs/windows)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            console.log('👁️ Page hidden - pausing auto-refresh');
            stopAutoRefresh();
        } else {
            console.log('👁️ Page visible - resuming auto-refresh');
            const workspaceTab = document.getElementById('workspace');
            if (workspaceTab && workspaceTab.style.display !== 'none') {
                startAutoRefresh();
            }
        }
    });

    /* 
    // DISABLED: Complex SSE implementation - keeping for reference
    // The SSE setup code is disabled since it's not working properly
    // If you want to re-enable it later, uncomment this section
    
    const repoNameElement = document.querySelector('meta[name="repository-name"]');
    const issueNumberElement = document.querySelector('meta[name="issue-number"]');

    if (repoNameElement && issueNumberElement) {
        // SSE code would go here...
        console.log('SSE setup disabled - using auto-refresh instead');
    }
    */
});

// Script to activate tab based on URL query parameter
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const tabToOpen = urlParams.get('tab_to_open');

    if (tabToOpen) {
        // Deactivate all tabs first
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            content.style.display = 'none';
        });

        // Activate the target tab
        const targetTabButton = document.querySelector(`.tab-button[data-tab="${tabToOpen}"]`);
        const targetTabContent = document.getElementById(tabToOpen);

        if (targetTabButton && targetTabContent) {
            targetTabButton.classList.add('active');
            targetTabContent.classList.add('active');
            targetTabContent.style.display = 'block';
            
            console.log(`Switched to tab: ${tabToOpen} from URL parameter`);
        } else {
            console.warn(`Tab or content for "${tabToOpen}" not found.`);
        }
    }
});
</script>
{% endblock %}
