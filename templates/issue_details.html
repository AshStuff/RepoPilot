{% extends "base.html" %}

{% block title %}{{ issue.title }} - Issue #{{ issue.number }}{% endblock %}

{% block head %}
<!-- Repository and issue metadata -->
<meta name="repository-name" content="{{ repository.full_name }}">
<meta name="issue-number" content="{{ issue.number }}">
{% endblock %}

{% block styles %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .dashboard-container {
        display: flex;
        height: 100vh;
    }

    /* Sidebar styles */
    .sidebar {
        width: 250px;
        min-width: 250px;
        background-color: #2f3136;
        border-right: 1px solid #26282c;
        height: 100vh;
        color: #dcddde;
        display: flex;
        flex-direction: column;
    }

    /* User profile section */
    .user-profile {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid #26282c;
        background-color: #2f3136;
    }

    .avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 10px;
        border: 2px solid #dcddde;
    }

    .user-profile h3 {
        margin: 10px 0 5px;
        color: #ffffff;
    }

    .user-profile p {
        color: #dcddde;
        font-size: 0.9em;
    }

    /* Navigation links */
    .sidebar-nav {
        display: flex;
        flex-direction: column;
        padding: 10px 0;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #dcddde;
        text-decoration: none;
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }

    .nav-link i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
    }

    .nav-link.active {
        background-color: #393c43;
        color: #ffffff;
        border-left-color: #7289da;
    }

    .nav-link:hover:not(.active) {
        background-color: #36393f;
        border-left-color: #dcddde;
    }

    .nav-link.logout {
        margin-top: auto;
        color: #ed4245;
        border-top: 1px solid #26282c;
    }

    .nav-link.logout:hover {
        background-color: #ed4245;
        color: white;
    }

    /* Main content */
    .main-content {
        flex: 1;
        background-color: #fff;
        position: relative;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .content-wrapper {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f6f8fa;
    }

    .issue-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .issue-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        background-color: #fff;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .issue-title {
        font-size: 1.5rem;
        color: #24292e;
    }

    .issue-title a {
        color: #586069;
        text-decoration: none;
    }

    .issue-title a:hover {
        color: #0366d6;
        text-decoration: underline;
    }

    /* Tab styles */
    .issue-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        border-bottom: 1px solid #e1e4e8;
        padding: 0 1rem;
        background-color: #fff;
        border-radius: 6px 6px 0 0;
    }

    .tab-button {
        padding: 1rem;
        border: none;
        background: none;
        color: #586069;
        font-size: 1rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s ease;
    }

    .tab-button:hover {
        color: #24292e;
    }

    .tab-button.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
        font-weight: 500;
    }

    .tab-content {
        display: none;
        background-color: #fff;
        border-radius: 0 0 6px 6px;
        padding: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .tab-content.active {
        display: block;
    }

    /* Issue details styles */
    .issue-details {
        margin-bottom: 2rem;
    }

    .issue-meta {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: #586069;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .issue-labels {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .issue-label {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .issue-body {
        color: #24292e;
        line-height: 1.5;
    }

    /* Comments section */
    .comments-section {
        margin-top: 2rem;
    }

    .comment {
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        margin-bottom: 1rem;
        padding: 1rem;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .comment-author {
        font-weight: 500;
        color: #24292e;
    }

    .comment-time {
        color: #586069;
        font-size: 0.9rem;
    }

    .comment-body {
        color: #24292e;
        line-height: 1.5;
    }

    /* Footer styles */
    .footer {
        background-color: #ffffff;
        color: #666666;
        padding: 15px 20px;
        text-align: center;
        font-size: 0.9em;
        border-top: 1px solid #e0e0e0;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
    }

    .footer-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
    }

    .footer-links {
        display: flex;
        gap: 20px;
    }

    .footer a {
        color: #666666;
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .footer a:hover {
        color: #333333;
    }

    /* Add these new styles */
    .issue-main-title {
        background-color: #fff;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .issue-main-title h2 {
        font-size: 1.8rem;
        color: #24292e;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .issue-meta-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .issue-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 1rem;
        border-radius: 2rem;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .issue-status.open {
        background-color: #2ea44f20;
        color: #2ea44f;
    }

    .issue-status.closed {
        background-color: #d73a4920;
        color: #d73a49;
    }

    .issue-status i {
        font-size: 1rem;
    }

    /* Update existing styles */
    .issue-details h2 {
        display: none; /* Hide the duplicate title in the details section */
    }

    /* Add these markdown content styles */
    .markdown-content {
        color: #24292e;
        line-height: 1.5;
        font-size: 1rem;
    }

    .markdown-content h1,
    .markdown-content h2,
    .markdown-content h3,
    .markdown-content h4,
    .markdown-content h5,
    .markdown-content h6 {
        margin: 1.5rem 0 1rem;
        font-weight: 600;
        line-height: 1.25;
    }

    .markdown-content h1 { font-size: 2em; }
    .markdown-content h2 { font-size: 1.5em; }
    .markdown-content h3 { font-size: 1.25em; }
    .markdown-content h4 { font-size: 1em; }
    .markdown-content h5 { font-size: 0.875em; }
    .markdown-content h6 { font-size: 0.85em; }

    .markdown-content p {
        margin-bottom: 1rem;
    }

    .markdown-content ul,
    .markdown-content ol {
        margin-bottom: 1rem;
        padding-left: 2rem;
    }

    .markdown-content li {
        margin: 0.25rem 0;
    }

    .markdown-content code {
        padding: 0.2em 0.4em;
        margin: 0;
        font-size: 85%;
        background-color: #f6f8fa;
        border-radius: 6px;
        font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    }

    .markdown-content pre {
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #f6f8fa;
        border-radius: 6px;
        overflow-x: auto;
    }

    .markdown-content pre code {
        padding: 0;
        background-color: transparent;
        font-size: 0.9em;
        line-height: 1.45;
    }

    .markdown-content blockquote {
        padding: 0 1em;
        color: #6a737d;
        border-left: 0.25em solid #dfe2e5;
        margin-bottom: 1rem;
    }

    .markdown-content img {
        max-width: 100%;
        height: auto;
        margin: 1rem 0;
    }

    .markdown-content table {
        border-spacing: 0;
        border-collapse: collapse;
        margin-bottom: 1rem;
        width: 100%;
    }

    .markdown-content table th,
    .markdown-content table td {
        padding: 6px 13px;
        border: 1px solid #dfe2e5;
    }

    .markdown-content table tr {
        background-color: #fff;
        border-top: 1px solid #c6cbd1;
    }

    .markdown-content table tr:nth-child(2n) {
        background-color: #f6f8fa;
    }

    /* Syntax highlighting */
    .highlight {
        background-color: #f6f8fa;
        border-radius: 6px;
    }

    .highlight pre {
        margin-bottom: 0;
        padding: 1rem;
    }

    /* Add terminal styles */
    .terminal-container {
        background-color: #1e1e1e;
        border-radius: 6px;
        padding: 1rem;
        height: 500px; /* Adjusted height */
        display: flex;
        flex-direction: column;
    }

    .terminal-header {
        display: flex;
        align-items: center;
        padding-bottom: 1rem;
        border-bottom: 1px solid #333;
        margin-bottom: 1rem;
    }

    .terminal-title {
        color: #fff;
        font-size: 0.9rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .terminal-controls { /* For window dressing buttons */
        display: flex;
        gap: 0.5rem;
    }

    .terminal-button {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
    }

    .terminal-button.close { background-color: #ff5f56; }
    .terminal-button.minimize { background-color: #ffbd2e; }
    .terminal-button.maximize { background-color: #27c93f; }

    /* Remove terminal input styles */
    .terminal-input-container,
    .terminal-prompt,
    .terminal-input {
        display: none;
    }

    /* Update terminal content to fill the space */
    .terminal-content {
        flex: 1;
        overflow-y: auto;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        color: #fff;
        padding-right: 1rem;
        padding-bottom: 1rem; /* Add padding at bottom for better spacing */
    }

    .log-entry {
        margin-bottom: 0.5rem;
        display: flex;
        align-items: flex-start;
    }

    .log-timestamp {
        color: #888;
        margin-right: 1rem;
        flex-shrink: 0;
        min-width: 140px; /* Fixed width for timestamps to align content */
    }

    .log-message {
        flex: 1;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .log-message.info { color: #7cafc2; }
    .log-message.success { color: #a1b56c; }
    .log-message.error { color: #ab4642; }
    .log-message.warning { color: #f7ca88; }
    
    /* Special styling for separator lines and section headers in terminal */
    .log-message.separator {
        color: #d7875f;
        font-weight: bold;
    }
    
    .log-message.section-header {
        color: #ffcc00;
        font-weight: bold;
        text-align: center;
    }

    /* Styles for markdown-formatted logs */
    .log-message.markdown-formatted {
        padding: 0.5rem;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        margin-top: 0.5rem;
    }
    
    .log-message.markdown-formatted code {
        background-color: rgba(0, 0, 0, 0.3);
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    }
    
    .log-message.markdown-formatted pre {
        background-color: rgba(0, 0, 0, 0.3);
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.5rem 0;
        overflow-x: auto;
    }
    
    .log-message.markdown-formatted h1,
    .log-message.markdown-formatted h2,
    .log-message.markdown-formatted h3,
    .log-message.markdown-formatted h4 {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        color: #ddd;
    }
    
    .log-message.markdown-formatted ul,
    .log-message.markdown-formatted ol {
        padding-left: 1.5rem;
        margin: 0.5rem 0;
    }
    
    .log-message.markdown-formatted table {
        border-collapse: collapse;
        margin: 0.5rem 0;
    }
    
    .log-message.markdown-formatted th,
    .log-message.markdown-formatted td {
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 4px 8px;
    }
    
    .log-message.markdown-formatted a {
        color: #7cafc2;
        text-decoration: underline;
    }

    /* Add styling for the missing info alert */
    .missing-info-alert {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 6px;
        padding: 20px;
        margin: 20px 0;
        color: #856404;
    }
    
    .missing-info-alert h3 {
        color: #856404;
        margin-bottom: 15px;
    }
    
    .retry-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
    }
    
    .retry-button:hover {
        background-color: #0069d9;
    }

    /* Styles for environment analysis */
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .info-group {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }

    .info-group h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #24292e;
        border-bottom: 1px solid #e1e4e8;
        padding-bottom: 8px;
    }

    .info-group ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .info-group li {
        margin: 8px 0;
        color: #586069;
    }
    
    .spinner {
        display: inline-block;
        animation: spin 1s linear infinite;
        color: #1a73e8;
        font-weight: bold;
    }
    
    .hidden {
        display: none;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    #ai-insights {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #e1e4e8;
    }

    /* Style for mini buttons in terminal header - These are no longer used but kept for reference */
    /*
    .mini-button {
        background-color: #333;
        color: #ccc;
        border: 1px solid #444;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .mini-button:hover {
        background-color: #444;
        color: #fff;
    }
    
    .mini-button i {
        font-size: 10px;
    }
    */

    /* Add status indicator styles */
    .status-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 10px;
        font-size: 22px; /* Increase size of indicators further */
    }

    .success-indicator {
        color: #28a745;
        font-weight: bold;
    }

    .error-indicator {
        color: #dc3545;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="user-profile">
            <img src="{{ user.avatar_url }}" alt="Profile" class="avatar">
            <h3>{{ user.name or user.login }}</h3>
            <p>@{{ user.login }}</p>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('dashboard') }}" class="nav-link">
                <i class="fas fa-book"></i>
                Repositories
            </a>
            <a href="{{ url_for('settings') }}" class="nav-link">
                <i class="fas fa-cog"></i>
                Settings
            </a>
            <a href="#" class="nav-link logout" onclick="event.preventDefault(); document.getElementById('logout-form').submit();">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </nav>
        <form id="logout-form" action="{{ url_for('logout') }}" method="POST" style="display: none;"></form>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-wrapper">
            <div class="issue-container">
                <div class="issue-header">
                    <h1 class="issue-title">
                        <a href="{{ url_for('repository_issues', repo_name=repository.full_name) }}">{{ repository.name }}</a>
                        / Issue #{{ issue.number }}
                    </h1>
                </div>

                <!-- Issue Title -->
                <div class="issue-main-title">
                    <h2>{{ issue.title }}</h2>
                    <div class="issue-meta-header">
                        <span class="issue-status {% if issue.state == 'open' %}open{% else %}closed{% endif %}">
                            <i class="fas {% if issue.state == 'open' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %}"></i>
                            {{ issue.state|capitalize }}
                        </span>
                        {% if issue.labels %}
                        <div class="issue-labels">
                            {% for label in issue.labels %}
                            <span class="issue-label" style="background-color: #{{ label.color }}20; color: #{{ label.color }};">
                                {{ label.name }}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Issue Tabs -->
                <div class="issue-tabs">
                    <button class="tab-button active" data-tab="issue" onclick="try { directTabSwitch('issue'); } catch(e) { document.getElementById('issue').style.display='block'; }; return false;">
                        <i class="fas fa-exclamation-circle"></i> Issue
                    </button>
                    <button class="tab-button" data-tab="workspace" onclick="try { directTabSwitch('workspace'); } catch(e) { document.getElementById('workspace').style.display='block'; }; return false;">
                        <i class="fas fa-code"></i> Workspace
                    </button>
                    <button class="tab-button" data-tab="summary" onclick="try { directTabSwitch('summary'); } catch(e) { document.getElementById('summary').style.display='block'; }; return false;">
                        <i class="fas fa-chart-bar"></i> Summary
                    </button>
                </div>

                <!-- Issue Tab Content -->
                <div id="issue" class="tab-content active" style="display: block;">
                    <div class="issue-details">
                        <div class="issue-meta">
                            <span>
                                <i class="fas fa-user"></i>
                                {{ issue.user.login }}
                            </span>
                            <span>
                                <i class="fas fa-clock"></i>
                                {{ issue.created_at|datetime }}
                            </span>
                        </div>
                        <div class="issue-body markdown-content">
                            {{ issue.body|markdown|safe }}
                        </div>
                        
                        <!-- Comments Section -->
                        <div class="comments-section">
                            <h3>Comments ({{ comments|length }})</h3>
                            {% for comment in comments %}
                            <div class="comment">
                                <div class="comment-header">
                                    <span class="comment-author">{{ comment.user.login }}</span>
                                    <span class="comment-time">commented {{ comment.created_at|datetime }}</span>
                                </div>
                                <div class="comment-body markdown-content">
                                    {{ comment.body|markdown|safe }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Workspace Tab Content -->
                <div id="workspace" class="tab-content" style="display: none;">
                    <div class="terminal-container" style="height: 600px;">
                        <div class="terminal-header">
                            <div class="terminal-controls">
                                <button class="terminal-button close"></button>
                                <button class="terminal-button minimize"></button>
                                <button class="terminal-button maximize"></button>
                            </div>
                            <div class="terminal-title">
                                Issue Analysis Terminal
                                <span id="analysis-status-indicator" class="status-indicator">
                                    <span id="loading-spinner" class="spinner">⟳</span>
                                    <span id="success-indicator" class="success-indicator hidden">✓</span>
                                    <span id="error-indicator" class="error-indicator hidden">✗</span>
                                </span>
                            </div>
                        </div>
                        <div class="terminal-content" id="terminalContent">
                            {% if logs %}
                                {% for log in logs %}
                                    <div class="log-entry">
                                        <span class="log-timestamp">
                                            {% if log.timestamp %}
                                                {{ log.timestamp|datetime }}
                                            {% else %}
                                                {{ issue.created_at|datetime }}
                                            {% endif %}
                                        </span>
                                        <span class="log-message {{ log.type }}">{{ log.message }}</span>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="log-entry">
                                    <span class="log-timestamp">{{ issue.created_at|datetime }}</span>
                                    <span class="log-message info">Initializing issue analysis...</span>
                                </div>
                                <div class="log-entry">
                                    <span class="log-timestamp">{{ issue.created_at|datetime }}</span>
                                    <span class="log-message info">No logs available yet. Analysis may be pending.</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Hide the container section - we'll show all info in the terminal logs -->
                    <div id="analysis-container" style="display: none;">
                        <div id="container-section" style="display: none;">
                            <h3>Environment Details</h3>
                            <div class="info-grid">
                                <div class="info-group">
                                    <h4>Container</h4>
                                    <ul>
                                        <li><strong>ID:</strong> <span id="container-id">-</span></li>
                                        <li><strong>Status:</strong> <span id="container-status">-</span></li>
                                        <li><strong>Name:</strong> <span id="container-name">-</span></li>
                                    </ul>
                                </div>
                                <div class="info-group">
                                    <h4>System</h4>
                                    <ul>
                                        <li><strong>OS:</strong> <span id="env-os">-</span></li>
                                        <li><strong>Python:</strong> <span id="env-python">-</span></li>
                                    </ul>
                                </div>
                                <div class="info-group">
                                    <h4>Packages</h4>
                                    <ul id="env-packages">
                                        <li>No packages detected</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <h3>AI Insights</h3>
                            <div id="ai-insights" class="markdown-content">
                                <p>Analysis in progress...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Also hide loading indicator -->
                    <div id="loading-analysis" style="display: none;"></div>
                </div>

                <!-- Summary Tab Content -->
                <div id="summary" class="tab-content" style="display: none;">
                    <h2>Summary</h2>
                    <p>Issue summary and analytics will be displayed here.</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-copyright">
                    © 2024 RepoPilot. All rights reserved.
                </div>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Contact</a>
                </div>
            </div>
        </footer>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include utility scripts -->
<script src="{{ url_for('static', filename='js/tab-switcher.js') }}"></script>
<script src="{{ url_for('static', filename='js/direct-tab-fix.js') }}"></script>

<!-- Add marked.js for client-side markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Configure marked options
marked.setOptions({
    highlight: function(code, lang) {
        return code;
    },
    breaks: true,
    gfm: true
});

document.addEventListener('DOMContentLoaded', function() {
    // Event listeners for clearAnalysisBtn, cleanupContainersBtn, and clearLogsBtn were removed.

    // SSE setup for logs
    const repoNameElement = document.querySelector('meta[name="repository-name"]');
    const issueNumberElement = document.querySelector('meta[name="issue-number"]');

    if (repoNameElement && issueNumberElement) {
        const repoName = repoNameElement.content;
        const issueNumber = issueNumberElement.content;
        const terminalContent = document.getElementById('terminalContent');
        const loadingSpinner = document.getElementById('loading-spinner');
        const successIndicator = document.getElementById('success-indicator');
        const errorIndicator = document.getElementById('error-indicator');

        let eventSource = null;
        let displayedLogMessages = new Set(); // To track displayed messages

        function connectSSE() {
            eventSource = new EventSource(`/api/issue-updates/${repoName}/${issueNumber}`);
            showLoading();

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    console.error("SSE Error:", data.error);
                    appendLog(data.error, 'error', new Date().toISOString());
                    showError();
                    eventSource.close(); 
                    return;
                }

                if (data.analysis && data.analysis.logs) {
                    data.analysis.logs.forEach(log => {
                        const logKey = `${log.timestamp}-${log.message}`;
                        if (!displayedLogMessages.has(logKey)) {
                            appendLog(log.message, log.type || 'info', log.timestamp);
                            displayedLogMessages.add(logKey);
                        }
                    });
                }

                if (data.analysis) {
                    updateStatusIndicators(data.analysis.analysis_status);
                    if (data.analysis.analysis_status === 'completed' || data.analysis.analysis_status === 'failed' || data.analysis.analysis_status === 'pending_user_input') {
                        hideLoading();
                        if (data.analysis.analysis_status === 'completed') showSuccess();
                        if (data.analysis.analysis_status === 'failed') showError();
                    } else if (data.analysis.analysis_status === 'in_progress' || data.analysis.analysis_status === 'processing') {
                        showLoading();
                    } else {
                        hideLoading(); 
                    }
                }
            };

            eventSource.onerror = function(err) {
                console.error("EventSource failed:", err);
                appendLog("Log stream connection error. Will attempt to reconnect shortly.", "error", new Date().toISOString());
                showError();
                eventSource.close();
                setTimeout(connectSSE, 5000); 
            };
        }
        
        function appendLog(message, type, timestamp) {
            if (!terminalContent) return;
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'log-timestamp';
            timestampSpan.textContent = time;

            const messageSpan = document.createElement('span');
            messageSpan.className = `log-message ${type.toLowerCase()}`;
            
            if (message.includes('```') || message.includes('###') || message.includes('**')) {
                messageSpan.innerHTML = marked.parse(message); 
                messageSpan.classList.add('markdown-formatted');
            } else {
                messageSpan.textContent = message;
            }

            logEntry.appendChild(timestampSpan);
            logEntry.appendChild(messageSpan);
            terminalContent.appendChild(logEntry);
            terminalContent.scrollTop = terminalContent.scrollHeight; 
        }

        function showLoading() {
            if(loadingSpinner) loadingSpinner.classList.remove('hidden');
            if(successIndicator) successIndicator.classList.add('hidden');
            if(errorIndicator) errorIndicator.classList.add('hidden');
        }

        function hideLoading() {
            if(loadingSpinner) loadingSpinner.classList.add('hidden');
        }

        function showSuccess() {
            if(loadingSpinner) loadingSpinner.classList.add('hidden');
            if(successIndicator) successIndicator.classList.remove('hidden');
            if(errorIndicator) errorIndicator.classList.add('hidden');
        }

        function showError() {
            if(loadingSpinner) loadingSpinner.classList.add('hidden');
            if(successIndicator) successIndicator.classList.add('hidden');
            if(errorIndicator) errorIndicator.classList.remove('hidden');
        }

        function updateStatusIndicators(status) {
            if (!status) return;
            switch(status.toLowerCase()) {
                case 'completed':
                    showSuccess();
                    break;
                case 'failed':
                case 'error_reproduced': 
                    showError();
                    break;
                case 'in_progress':
                case 'processing':
                case 'pending':
                case 'container_created': 
                    showLoading();
                    break;
                case 'pending_user_input':
                    hideLoading(); 
                    break;
                default:
                    hideLoading(); 
                    break;
            }
        }
        connectSSE();
    } else {
        console.warn('Repository metadata not found for SSE connection.');
    }
});
</script>
{% endblock %}
